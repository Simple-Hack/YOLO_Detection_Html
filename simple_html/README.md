# 驾驶行为检测系统

## 项目概述

驾驶行为检测系统是一个基于深度学习的Web应用，能够实时检测和分析驾驶员的行为，旨在提高道路安全性。系统通过分析图像和视频内容，识别各种驾驶行为，如安全驾驶、使用手机、喝水等，并提供相应的风险评估和安全建议。

![系统界面预览](res/pic/preview.jpg)

## 主要功能

- **图像检测**：识别图片中的驾驶行为
- **视频分析**：处理视频内容，实时识别驾驶行为并标注
- **风险评估**：对检测到的行为进行风险分析并生成警告
- **安全建议**：基于检测结果提供个性化的驾驶安全建议
- **数据统计**：提供检测数据的统计和图表分析
- **历史记录**：查询和管理历史检测记录
- **AI安全问答**：与AI助手进行交通安全问题的交互

## 系统架构

### 前端技术栈

- 原生JavaScript（客户端逻辑）
- HTML5/CSS3（页面结构和样式）
- Chart.js（数据可视化）
- FontAwesome（图标）
- Flatpickr（日期选择器）
- Marked.js（Markdown解析）
- Highlight.js（代码高亮）

### 后端技术栈

- Python Flask（Web服务器）
- SQLite（数据存储）
- YOLO模型（目标检测）
- Deepseek大语言模型（生成驾驶建议和问答）
- OpenCV（视频处理）
- FFmpeg（视频格式转换）

## 文件结构

```
simple_html/
├── index.html           # 主HTML文件
├── css/
│   ├── styles.css       # 主样式表
│   └── aiChat.css       # AI聊天界面样式
├── js/
│   ├── main.js          # 主JavaScript文件
│   ├── config.js        # 配置文件
│   ├── uiUtils.js       # UI工具函数
│   ├── resultDisplay.js # 结果显示模块
│   ├── videoHandler.js  # 视频处理模块
│   ├── aiChat.js        # AI聊天功能模块
│   ├── dashboard.js     # 数据看板功能模块
│   ├── historyView.js   # 历史记录功能模块
│   ├── speechRecognition.js # 语音识别模块
│   └── debug.js         # 调试工具模块
├── res/
│   └── pic/             # 图片资源
├── uploads/             # 上传文件临时目录
├── static/
│   └── outputs/         # 处理结果输出目录
├── detection_history.db # SQLite数据库
├── deepseek_detect_0.py # Python后端服务器
└── models/              # 模型目录
    └── car_inside_detect.pt # YOLO检测模型
```

## 模块说明

### 前端核心模块

1. **resultDisplay.js**
   - 负责处理和展示检测结果
   - 生成类别摘要和统计图表
   - 显示详细检测信息和分页控制

2. **videoHandler.js**
   - 处理视频文件播放控制
   - 管理视频预览和进度显示
   - 处理预警时间点标记和跳转

3. **aiChat.js**
   - 提供AI交互对话界面
   - 处理用户问题发送和响应显示
   - 支持Markdown格式化和思考过程展示

4. **dashboard.js**
   - 数据看板功能实现
   - 生成检测统计图表和趋势分析
   - 数据定时自动刷新

5. **historyView.js**
   - 历史记录查询和过滤
   - 分页显示和详情查看
   - 历史记录管理操作

### 后端核心功能

1. **图像检测**
   - 使用YOLO模型检测图像中的驾驶行为
   - 生成标注图像并返回检测结果
   - 计算统计信息和可信度

2. **视频分析**
   - 逐帧处理视频内容
   - 连续行为确认和跟踪
   - 生成标注视频和时间线预警

3. **AI建议生成**
   - 基于检测结果生成专业建议
   - 使用Deepseek模型进行自然语言理解和生成
   - 支持Markdown格式输出

4. **数据存储与查询**
   - 使用SQLite存储检测历史和统计信息
   - 提供多条件查询和过滤功能
   - 维护历史记录和文件管理

## 界面功能

### 主界面

- **导航菜单**：检测、数据看板、历史记录、安全问答
- **上传区域**：支持拖放和点击上传图片或视频
- **预览区域**：显示上传文件预览
- **操作按钮**：开始检测、重新上传、调试信息

### 检测结果界面

- **媒体显示**：显示检测结果图像或视频
- **统计信息**：展示检测数量、类别、置信度等统计数据
- **类别摘要**：显示各类别的检测结果和统计
- **详细信息**：分页展示所有检测项目详情
- **图表分析**：通过图表可视化展示检测数据
- **驾驶建议**：显示AI生成的驾驶安全建议

### 数据看板

- **统计卡片**：显示总检测数、当日检测、预警数等核心指标
- **趋势图表**：展示最近7天的检测趋势
- **预警占比**：显示预警与正常检测的比例
- **行为分布**：展示各类驾驶行为的分布情况

### 历史记录

- **筛选工具栏**：按文件类型、检测类别、日期等筛选
- **记录表格**：显示历史检测记录的详细信息
- **分页控件**：支持大量记录的分页浏览
- **详情弹窗**：查看历史记录的详细检测结果

### AI安全问答

- **对话界面**：全屏对话交互界面
- **消息区域**：展示用户问题和AI回答
- **输入区域**：文本输入框和辅助按钮
- **思考过程**：可显示AI的思考过程和推理
- **语音输入**：支持语音识别输入问题

## 前后端交互

### API接口

1. **`/predict`**
   - 方法：POST
   - 功能：处理图像检测请求
   - 参数：file（图像文件）
   - 返回：检测结果、统计信息、建议等

2. **`/predict_video`**
   - 方法：POST
   - 功能：处理视频检测请求
   - 参数：file（视频文件）
   - 返回：检测结果、统计信息、预警、建议等

3. **`/progress`**
   - 方法：GET
   - 功能：获取视频处理进度
   - 参数：filename（文件名）
   - 返回：处理进度百分比

4. **`/ask`**
   - 方法：POST
   - 功能：AI问答接口
   - 参数：question（问题文本）
   - 返回：AI回答内容

5. **`/ask_stream`**
   - 方法：POST
   - 功能：AI问答流式接口
   - 参数：question（问题文本）
   - 返回：流式AI回答内容

6. **`/dashboard_stats`**
   - 方法：GET
   - 功能：获取数据看板统计信息
   - 返回：总体统计、趋势数据、分类统计等

7. **`/detection_history`**
   - 方法：GET
   - 功能：获取历史检测记录
   - 参数：page、per_page、筛选条件
   - 返回：分页历史记录数据

8. **`/delete_history`**
   - 方法：DELETE
   - 功能：删除历史记录及相关文件
   - 参数：id（记录ID）
   - 返回：操作结果

### 数据库结构

1. **`detection_history`表**
   - 存储检测主记录
   - 包含文件信息、检测时间、结果路径等

2. **`detection_details`表**
   - 存储检测详细信息
   - 关联检测主记录，包含类别、置信度等

3. **`detection_stats`表**
   - 存储每日统计数据
   - 包含检测数、预警数、AI问答数等

## 启动和配置

### 启动前端

前端为静态网页，只需将项目文件放在Web服务器的根目录即可访问。

### 启动后端

```bash
# 启动Flask后端服务
python deepseek_detect_0.py --port 5050
    
    ```
### 启动Ollama服务（用于AI建议和问答）

```bash
# 启动Ollama服务
ollama serve

# 拉取所需模型
ollama pull deepseek-r1:1.5b
```

## 系统要求

- **操作系统**：Windows 10/11 或 Linux
- **Python**：3.12+
- **GPU**：建议NVIDIA GPU 8GB+（用于模型推理）
- **磁盘空间**：至少20GB（模型和临时文件）
- **RAM**：16GB+

## 开发者说明

系统采用模块化设计，各功能独立封装为不同的JavaScript和Python模块，便于扩展和维护。前端使用原生JavaScript实现，没有使用框架，提高了加载速度和兼容性。后端使用Flask提供RESTful API服务，整合了YOLO检测模型和Deepseek大语言模型。

## 许可证

[MIT License](LICENSE)